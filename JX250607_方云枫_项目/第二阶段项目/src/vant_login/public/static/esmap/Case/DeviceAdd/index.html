<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <!-- <meta HTTP-EQUIV="pragma" CONTENT="no-cache"> -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <title>室内三维场景添加摄像头|易景三维可视化平台</title>
    <meta name="keywords" content="室内三维场景添加设备,室内三维场景添加摄像头,室内三维场景,三维场景引擎,室内定位,易景三维场景" />
    <meta name="description" content="室内三维场景添加设备,室内三维场景添加摄像头,易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。" />
    <link rel="shortcut icon" type="image/ico" href="../../image/favicon.ico">
    <link type="text/css" rel="stylesheet" href="../../lib/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="css/common.css">
    <link type="text/css" rel="stylesheet" href="css/formstyle.css" />
    <style>
        .center-group{
			position: absolute;
			right: 75px;
			top: 12%;
		}
		html, body {
		    background-color: rgb(60, 96, 112);
		}
	    .navbar {
            margin-bottom: 0;
        }
        
        .btn-group-vertical .btn  {
            padding: 5px 11px;
            color:rgb(200, 210, 218);
            background-color: rgb(27, 103, 141);
            border: none;
            cursor: pointer;
            border: 1px solid rgb(1, 18, 27)
        }
        .zoneinfo {
            margin-top: 20px; 
        }
        .imgangel {
            position: relative;
            width: 20px;
            height: 20px;
            top: 4px;
            left: 75px;
            cursor: pointer;
            background-color: #4d9fcf;
            border-radius: 50%;
        }
        #map-container{
            position: relative;
            width: inherit;
            top:0;
            height:100%;
        }
        .f-left{
            float: left;
            width: 242px;
            margin-left: -249px;
        }
        .f-right{
            float: right;
            width: 100%;
            height: 100%;
            padding-bottom: 40px;
            background-color: lightseagreen; 
        }
        .main{
            padding-left: 242px;
            height: 100%;
        }
	</style>
</head>

<body>
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <h1><a href="/" title="室内三维场景设备添加-摄像头添加" target="_blank">易景室内三维可视化引擎</a>（室内三维场景设备添加）</h1>
            <div class="tips-right">
                <span class="tip1"></span>
                <span class="tip2"></span>
            </div>
            <div class="tips-msg">
                <div class="msg msg1">
                    <div class="erweima"></div>
                    <p>手机扫一扫进入体验</p>
                </div>
                <div class="msg msg2">
                    <h4>室内三维场景设备添加功能(摄像头添加)</h4>
                    <p>1. 在三维场景上点击添加摄像头位置</p>
                    <p>2. 可以设置摄像头的探测边界范围</p>
                    <div style="display: none">室内三维场景添加设备,室内三维场景添加摄像头,可以设置摄像头的探测边界范围,易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。</div>
                </div>
            </div>
        </div>
    </nav>
    <div class="main">
                        <div class="f-left" id="formid" style="max-width:700px;float:left">
                            <form action="#" method="post" id="zoneinfo" class="smart-green">
                                <div class="form-group">
                                    <label for="floorname" class="control-label">楼层名称:</label>
                                    <select id="fid">
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="maintype" class="control-label">摄像头类型:</label>
                                    <select id="maintype">
                                        <option value="image/camera1.png">枪机</option>
                                        <option value="image/camera2.png">球机</option>
                                        <option value="image/camera3.png">半球</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="title" class="control-label">摄像头名称:</label>
                                    <input type="text" class="form-control" id="title" placeholder="cameraName">
                                </div>
                                <div class="form-group">
                                    <label for="deviceid" class="control-label">摄像头id:</label>
                                    <input type="text" class="form-control" id="deviceid" placeholder="deviceid">
                                </div>

                                <div class="form-group">
                                    <label for="angletype" class="control-label">摄像头角度:</label>
                                    <input type="text" class="form-control" id="angletype" placeholder="angle">
                                    <img class="imgangel" id="add" onclick = "addAngle()" src="image/camer/add.png">
                                    <img class="imgangel" id="cut" onclick = "cutAngle()" src="image/camer/cut.png">
                                </div>
                                <div class="form-group">
                                    <label for="longtitude" class="control-label">摄像头经度:</label>
                                    <input type="text" class="form-control" id="longtitude" placeholder="longitude">
                                </div>
                                <div class="form-group">
                                    <label for="latitude" class="control-label">摄像头纬度:</label>
                                    <input type="text" class="form-control" id="latitude" placeholder="latitude">
                                </div>
                                <div class="form-group">
                                    <label for="gpsbounds" class="control-label">监控范围边界:</label>
                                    <input type="text" class="form-control" id="gpsbounds" placeholder="(0,0),(1,1)">
                                </div>
                                <div class="form-group">
                                    <label for="description" class="control-label">摄像头描述:</label>
                                    <textarea class="form-control" l="8000" maxlength="8000" id="description"
                                        placeholder="description"></textarea>
                                </div>
                                <div class="form-group">
                                    <input type="button" class="mybutton" id="submit" value="保存" style="color:rgb(67, 104, 133);font-weight:700;border-radius:3px">
                                </div>
                            </form>
                        </div>
                        <div class="f-right">
                            <div style="background:#fff;float:left" id="map-container"></div>
                            <div style="position:relative;top:610px;background:#fff;height:0px;width:100%"></div>
                        </div>
            

            <!--中心点、边界添加按钮组  -->
            <div class="center-group btn-group-vertical" data-toggle="buttons">
                <button id="addCenter" class="btn btn-default btnclass">添加摄像头位置</button>
                <button id="addBound" class="btn btn-default btnclass">添加监控范围</button>
                <button id="reset" class="btn btn-default btnclass">重置</button>
            </div>
    </div>

    <script src="../../lib/config.js"></script>
    <script src="../../lib/esmap-3.0.min.js"></script>
    <script src="../../lib/jquery-2.1.4.min.js"></script>
    <script src="../../lib/jquery.qrcode.min.js"></script>
    <script src="../../lib/tips_controls.js"></script>
    <script type="text/javascript">
    var seg, im, line1;
    var fnum, line;
    var flag = false;
    var boundFlag = false;
    var coordsData = null;
    var coordIndex = 0;
    var mapCoord;
    //定义map、floorLayer全局变量
    var map;
    var floorLayer;
    var centerFlag = false;
    var boundFlag = false;
    var linelayer;
    var devicelayer;
    var id = getQueryString('id') || defaultOpt.mapID;
    var container = document.getElementById('map-container');
    var building;
    map = new esmap.ESMap({
        mode: esmap.MapMode.Building,
        container: container, //渲染dom
        mapDataSrc: "../../data", //三维场景数据位置
        mapAudioSrc: '../lib',
		token:'escope'
    });
    var floorControl;
    //楼层控制控件配置参数(选几楼)
    var ctlOpt = new esmap.ESControlOptions({
        position: esmap.ESControlPositon.RIGHT_TOP,
        imgURL: "image/wedgets/"
    });

    //打开三维场景数据
    map.openMapById(id);
    map.showCompass = true;

    map.on("loadComplete", function () {
        building = map.getBuilding();
        //创建楼层控件
        floorControl = new esmap.ESScrollFloorsControl(map, ctlOpt);
        for(var i=0;i<building.floorNames.length;i++)
        {
            $("#fid").append('<option value="'+(i+1)+'">'+(building.floorNames[i])+'</option>')
        }
        $("#fid").value = 1;
    });
    //载入json数据
    $.getJSON("data/devicelist.json", function (data) {
        coordsData = data.rows;
    });
    //三维场景点击事件  获取三维场景坐标x,y坐标
    map.on("mapClickNode", function (e) {
        mapCoord = e.hitCoord || null;
    })

    //点击事件 
    map.on('mapClickNode', function(event) {
        if (event.nodeType == esmap.ESNodeType.FLOOR||event.nodeType ==esmap.ESNodeType.MODEL)
        {
            var focusFloorNum = building.focusFloorNum;
            if (centerFlag) {
                $("#angletype").val(10); //摄像头角度值
                drawPoints(event.hitCoord.x, event.hitCoord.y, focusFloorNum);
                flag = true; //添加摄像头以后，图层存在 打开开关 
                $('#latitude').val(event.hitCoord.x.toFixed(6)); //摄像头经度值
                $('#longtitude').val(event.hitCoord.y.toFixed(6)); //摄像头纬度值
                $("#deviceid").val(++coordIndex); //摄像头id
            }
            if (boundFlag) {
                drawLine1(event.hitCoord.x, event.hitCoord.y, focusFloorNum);
            }
        }
    });
    var maintype = $("#maintype");
    //添加摄像头图片标注
    function drawPoints(x, y, focusFloorNum) {
        devicelayer.removeAll();
        var floorLayer = building.getFloor(1);
			var layer = floorLayer.getOrCreateLayerByName("cameras", esmap.ESLayerType.MODEL3D);
             im = new esmap.ES3DMarker({
                x: x,
                y: y,
                id: 1,
                name: "camera",
                url: 'model/White-Gun-Camera.gltf',
                size: 5,
                angle:0,
                height: 5,
            });
            //切换摄像头类型
        var maintype = $("#maintype");
        maintype.change(function () {
            // im.url = $(this).val();
        });
			devicelayer.addMarker(im);
    }
    //添加线的 点标注
    function drawLinePoints(x, y, focusFloorNum) {
        var im = new esmap.ESTextMarker({
            x: x,
            y: y,
            image: 'image/user.png',
            scale: 1,
            height: 2,
            seeThrough: false,
            showLevel: 24
        });
        linelayer.addMarker(im);
    }
    //切换楼层
    var fid = $("#fid");
    fid.change(function () {
        map.changeFocusFloor($(this).val());
        reset.click();
        map.clearLineMarkById("bline"); //清除边框线
        floorLayer = null;
        line = null;
        seg = null;
        centerFlag = false;
        boundFlag = false;
    });

    function addAngle() { //改变角度  增加旋转角度
        var angle = $("#angletype").val();
        angle = Number(angle) + 10;
        $("#angletype").val(angle);
        fnum = building.focusFloorNum;
        updateMakerAngle(angle, fnum);
    }

    function cutAngle() { //改变角度  减少旋转角度
        var angle = $("#angletype").val();
        angle = Number(angle) - 10;
        $("#angletype").val(angle);
        fnum = building.focusFloorNum;
        updateMakerAngle(angle, fnum);
    }

    function updateMakerAngle(angle, fnum) { //刷新摄像头角度
        im.rotateTo(angle);
    }

    //重置按钮
    var reset = document.getElementById("reset");
    reset.onclick = function () {
        $('#latitude').val(null); //摄像头经度值
        $('#longtitude').val(null); //摄像头纬度值
        $("#deviceid").val(null); //摄像头id
        $("#angletype").val(null); //摄像头角度

        if (devicelayer) devicelayer.removeAll();
        if (linelayer) linelayer.removeAll(); //删除所有标注
        map.clearLineMarkById("bline"); //清除边框线
        if (seg)
            seg = [];
        centerFlag = false;
        boundFlag = false;
    }

    //线型
    var lineStyle = {
        color: "#F00000",
        lineWidth: 5,
        fixedWidth: true,
        alpha: 0.8,
        offsetHeight: 2,
        seeThrough: true,
        lineType: esmap.ESLineType.DOT_DASH,
        dash: {
            size: 2,
            gap: 1
        }
    };

    // 点击添加摄像头
    $("#addCenter").click(function () { //添加摄像头位置
        centerFlag = true;
        boundFlag = false;
        if (devicelayer) devicelayer.removeAll();
        floorLayer = building.getFloor(building.focusFloorNum); //获取图层
        devicelayer = new esmap.ESLayer(esmap.ESLayerType.MODEL3D);
        floorLayer.addLayer(devicelayer);
        if (seg)
            seg = [];

    });
    //添加监控范围
    var addBound = $("#addBound");
    addBound.click(function () {
        boundFlag = true;
        centerFlag = false;
        map.clearLineMarkById("bline"); //清除边框线
        if (linelayer) linelayer.removeAll(); //删除所有线标注
        floorLayer = building.getFloor(building.focusFloorNum); //
        linelayer = new esmap.ESLayer(esmap.ESTextMarker);
        floorLayer.addLayer(linelayer);
        if (seg)
            seg = [];
        alert('请按顺序在三维场景上点击选择至少3个边界点！');
    });

    //画边界线
    function drawLine1(x1, y1, fnum) {
        if (!seg) {
            seg = [];
        }
        seg.push({
            x: x1,
            y: y1,
            fnum: fnum
        });
        var cnt = seg.length;
        var newseg = [].concat(seg);
        var value = '';
        newseg.push(seg[0]);
        if (cnt > 2) {
            var isok = true;
            for (var i = 0; i < cnt - 2; i++) {
                var flag, distance;
                distance = Math.sqrt(Math.pow(seg[cnt - 1].x - seg[i].x, 2) + Math.pow(seg[cnt - 1].y - seg[i].y, 2));
                //点的位置与其它点太近
                if (distance < 1) {
                    isok = false;
                    break;
                }
                //判断最后一条线和其他所有线段有没有交点
                flag = segmentsIntr(seg[i], seg[i + 1], seg[cnt - 2], seg[cnt - 1]);
                if (flag) { //如果有交点
                    isok = false;
                    break;
                } else {
                    //判断最后第二条线和其他所有线段有没有交点
                    flag = segmentsIntr(seg[i], seg[i + 1], seg[cnt - 1], seg[0]);
                    if (flag) {
                        isok = false;
                        break;
                    }
                }
                value += '(' + seg[i].x.toFixed(6) + ',' + seg[i].y.toFixed(6) + '),'; //监控边界值
            }
            value += '(' + seg[cnt-2].x.toFixed(6) + ',' + seg[cnt-2].y.toFixed(6) + '),'; //监控边界值
            value += '(' + seg[cnt-1].x.toFixed(6) + ',' + seg[cnt-1].y.toFixed(6) + ')'; //监控边界值
            $('#gpsbounds').val(value);

            if (isok) {
                map.clearLineMarkById("bline");
                drawLinePoints(x1, y1, fnum); //添加摄像头的位置  一个点
                var line = new esmap.ESLineMarker({points: newseg, style: lineStyle,id: 'bline'});
                map.drawLineMark(line);
            } else { //不满足条件 抛弃新点
                seg.pop();
            }
        } else if (cnt > 1) { //有两个点画一条直线
            drawLinePoints(x1, y1, fnum);
            map.clearLineMarkById("bline");
            var line1 = new esmap.ESLineMarker({points: newseg, style: lineStyle,id: 'bline'});
            map.drawLineMark(line1);
        } else {
            drawLinePoints(x1, y1, fnum);
        }
    }
    //判断两条直线是否相交，相交返回交点，不相交返回false
    function segmentsIntr(a, b, c, d) {

        if ((a.x == c.x && a.y == c.y) || (b.x == c.x && b.y == c.y) || (a.x == d.x && a.y == d.y) || (b.x == d.x && b.y == d.y))
            return false;
        // 三角形abc 面积的2倍  
        var area_abc = (a.x - c.x) * (b.y - c.y) - (a.y - c.y) * (b.x - c.x);
        // 三角形abd 面积的2倍  
        var area_abd = (a.x - d.x) * (b.y - d.y) - (a.y - d.y) * (b.x - d.x);
        // 面积符号相同则两点在线段同侧,不相交 (对点在线段上的情况,本例当作不相交处理);  
        if (area_abc * area_abd > 0) {
            return false;
        }

        // 三角形cda 面积的2倍  
        var area_cda = (c.x - a.x) * (d.y - a.y) - (c.y - a.y) * (d.x - a.x);
        // 三角形cdb 面积的2倍  
        // 注意: 这里有一个小优化.不需要再用公式计算面积,而是通过已知的三个面积加减得出.  
        var area_cdb = area_cda + area_abc - area_abd;
        if (area_cda * area_cdb > 0) {
            return false;
        }

        //计算交点坐标  
        var t = area_cda / (area_abd - area_abc);
        var dx = t * (b.x - a.x),
            dy = t * (b.y - a.y);
        return {
            x: a.x + dx,
            y: a.y + dy
        };
    }
    //保存按钮
    var submit = document.getElementById("submit");
    submit.onclick = function () {
        var myselect=document.getElementById("maintype");
        var index=myselect.selectedIndex;
        alert("当前楼层：" + building.focusFloorNum + "楼" + "\n" +
            "摄像头类型：" + myselect.options[index].text + "\n" +
            "摄像头ID：" + $('#deviceid').val() + "\n" +
            "摄像头角度：" + $("#angletype").val() + "\n" +
            "摄像头经度：" + $('#latitude').val() + "\n" +
            "摄像头纬度：" + $('#longtitude').val() + "\n" +
            "请自行编写后台接口！");
    }
</script>
</body>
</html>
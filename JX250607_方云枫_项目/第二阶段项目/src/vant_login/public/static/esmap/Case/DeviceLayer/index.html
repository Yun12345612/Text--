<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>室内三维场景设备图层管理|易景三维可视化平台</title>
    <meta name="keywords" content="室内三维场景设备图层管理,图层管理,点击设备人员查看详情,室内三维场景,三维场景引擎" />
    <meta name="description" content="室内三维场景设备图层管理,点击设备人员查看详情,图层管理,易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。" />
    <link href="../../lib/bootstrap.min.css" rel="stylesheet">
    <link href="css/common.css" rel="stylesheet">
    <link href="css/iconfont/iconfont.css" rel="stylesheet">
</head>
<style type="text/css">
</style>
<body ms-controller="ctrl" class="ms-controller">
    <div id="map-container">
       
    </div>
    <div id="toolcheck" class="mycheck">  
        <div class="mycheckcommon">
             <input type="checkbox" value="1" id="device1" name="" checked/>  
             <label for="device1"></label><span>摄像头</span>
            </div>
        <div class="mycheckcommon">
         <input type="checkbox" value="1" id="device2" name="" checked/>  
         <label for="device2"></label><span>消防设备</span>
        </div>
         <div class="mycheckcommon">
             <input type="checkbox" value="1" id="device3" name="" checked/>  
             <label for="device3"></label><span>安保人员</span>
        </div>
   </div> 
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <h1><a href="/" title="室内三维场景-三维场景轨迹回放" target="_blank">易景室内三维可视化引擎</a>（设备图层管理-点击设备、人员查看详情）</h1>
            <div class="tips-right">
                <span class="tip1"></span>
                <a class="tip2" onclick="tipClick('/api/marker/image/')"></a>
            </div>
            <div class="tips-msg">
                <div class="msg msg1">
                    <div class="erweima"></div>
                    <p>手机扫一扫进入体验</p>
                </div>
                <div class="msg msg2">
                    <h4>室内三维场景-设备图层管理</h4>
                    <p>1. 点击右下角复选框可以显示或隐藏相应图层</p>
                    <p>2. 点击三维场景上的图标可以弹出图层设备的基本信息</p>
                    <p>3. 点击设备、人员查看详情</p>
                    <div style="display: none">易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功

能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短

、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。</div>
                </div>
            </div>
        </div>
    </nav>
    <script src="../../lib/config.js"></script>
    <script src="../../lib/esmap-3.0.min.js"></script>
    <script src="../../lib/jquery-2.1.4.min.js"></script>
    <script src="../../lib/jquery.qrcode.min.js"></script>
    <script src="../../lib/tips_controls.js"></script>
    <script src="../../lib/bootstrap.min.js"></script>
    <script type="text/javascript">
        //定义全局map变量
        var map;
        var esmapID = getQueryString('id') || defaultOpt.mapID;//需要加载的三维场景id默认test666
        var floorControl;//楼层控件
        var building;
        var showdevicetype={'1':'true','2':'true','3':'true'};//复选框改变事件出用到
        var baoanMakrker=[];//保安marker集合，用于控制保安人员的移动路线
        // 楼层控制控件配置参数（几楼）
        var ctlOpt = new esmap.ESControlOptions({
            position: esmap.ESControlPositon.RIGHT_TOP,
            imgURL: 'image/wedgets/'
        })
        // 放大、缩小控件配置
        var ctlOpt1 = new esmap.ESControlOptions({
            position: esmap.ESControlPositon.LEFT_TOP, // 位置 左上角
            // 位置x,y的偏移量
            offset: {
                x: 10,
                y: 70
            },
            imgURL: 'image/wedgets/'
        })
        map = new esmap.ESMap({
            mode: esmap.MapMode.Building,
            container: $('#map-container')[0], // 渲染dom
            mapDataSrc: "../../data", //三维场景数据位置
            focusAlphaMode: true, // 对不可见图层启用透明设置 默认为true
            focusAnimateMode: true, // 开启聚焦层切换的动画显示
            focusAlpha: 0.9, // 对不聚焦图层启用透明设置，当focusAlphaMode = true时有效
            mapAudioSrc: '../lib',
		    token:'escope',
            defaultScaleLevel:5,//默认缩放等级
            focusFloor: 1//初始化聚焦楼层
        });
        map.openMapById(esmapID);
        map.showCompass = true; //显示指南针 
        //三维场景加载完成回调
        map.on('loadComplete', function () {
            building = map.getBuilding();
            floorControl = new esmap.ESScrollFloorsControl(map, ctlOpt);//创建楼层控件
            // var zoomControl = new esmap.ESZoomControl(map, ctlOpt1);//创建放大缩小控件
            bingEvents();//绑定按钮点击事件
            loadDeviceData();//加载自己构造好的json格式数据
        });
        //三维场景点击事件回调
        map.on('mapClickNode', function(event) {
            console.log(event);
            if(event && event.hasOwnProperty("deviceType")){//这里判断点击的是否是自己新增的设备marker
                showPop(event);
            }
        });
        //绑定事件
        function bingEvents() {
            //复选框改变事件
            for(var type in showdevicetype)
            {
                (function(type_){			
                    $("#device"+type_).change(function(){
                        if($("#device"+type_).is(':checked')){
                            showdevicetype[type_]=true;
                            hideOrShowLayer(['device'+type_],true);
                        }else{
                            showdevicetype[type_]=false;
                            hideOrShowLayer(['device'+type_],false);
                        }
                    });
                })(type)
            }
        }
        //加载图层数据
        function loadDeviceData(){
            $.getJSON("device.json", function (data) {
                if(data){
                    var devices = data.devices;
                    for (let i = 0; i < devices.length; i++) {
                        const obj = devices[i];
                        addDeviceMarker(obj);//在三维场景上添加设备marker
                    }
                }
            });  
            $.getJSON("baoan.json", function (data) {
                if(data){
                    var baoan = data.data;
                    for (let i = 0; i < baoan.length; i++) {
                        const obj = baoan[i];
                        addTextMarker(obj); //在三维场景上添加安保人员marker
                    }
                }
            });  
        }
        //在三维场景上添加设备marker
        function addDeviceMarker(obj){
            //通过名字区别创建不同的layer
            var floorLayer = building.getFloor(obj.fnum);  //获取第一层的楼层对象
            var layer=floorLayer.getOrCreateLayerByName("device"+obj.type,esmap.ESLayerType.TEXT_MARKER);//"device"+type 隐藏/删除的时候用
            var url= 'image/'+obj.type+'.png';
            im = new esmap.ESTextMarker({
                seeThrough: true,
                x:obj.x,                //坐标x
                y:obj.y,                //坐标y
                image:url,                //图片地址
                scale: 1,   		
                height:1,    			//距离地面高度
                showLevel: 20,  		//三维场景缩放等级达到多少时隐藏,可选参数
                seeThrough: true,		//是否可以穿透楼层一直显示,可选参数
                id: obj.id,   			//id，可自定义
                name:obj.name   		//name可自定义
            });
            im.deviceType=obj.type;         //自定义属性-用于点击事件中区分点击的是什么类型的设备
            layer.addMarker(im);        //将marker添加到图层
            floorLayer.addLayer(layer); //将图层添加到楼层对象
        }
        //在三维场景上添加安保人员marker
        function addTextMarker(obj){
            //通过名字区别创建不同的layer
            var floorLayer = building.getFloor(obj.fnum);  //获取第一层的楼层对象
            var layer=floorLayer.getOrCreateLayerByName("device"+obj.type,esmap.ESLayerType.TEXT_MARKER);//"device"+type 隐藏/删除的时候用
            var url= 'image/'+obj.type+'.png';
            var tm = new esmap.ESTextMarker({
                x:obj.x,                //坐标x
                y:obj.y,                //坐标y
                id: obj.id,             //id，可自定义
                image: url,             //图片标注的图片地址
                imageStyle: {
                    align: 'bottom',
                },
                text:obj.name,	        //文字名称
                scale:1,			    //文字等级缩放默认为1,可选参数,0.1表明缩小10倍
                height:1,    		    //距离地面高度
                showLevel: 20,  		//三维场景缩放等级达到多少时隐藏,可选参数
                textStyle: {
                    fillStyle: "#FFFFFF",     //填充色
                    fontSize: 16,           //字体大小
                    strokeStyle: "#000", //边框色
                }
            });
            tm.deviceType=obj.type;         //自定义属性-用于点击事件中区分点击的是什么类型的设备
            tm.routePoints=obj.routePoints; //人员的移动路径
            baoanMakrker.push(tm);
            layer.addMarker(tm);        //将marker添加到图层
            floorLayer.addLayer(layer); //将图层添加到楼层对象
            baoanMoveRoute();//控制保安的移动
        }

        //控制保安的移动
        function baoanMoveRoute(){
            if(baoanMakrker && baoanMakrker.length>0){
                var index=0;
                setInterval(function(){
                    for (let i = 0; i < baoanMakrker.length; i++) {
                        const bamarker = baoanMakrker[i];
                        var routePoints=bamarker.routePoints;
                        var point=routePoints[index];
                        bamarker.moveTo({x: point.x,y: point.y,time:0});//移动marker 
                    }
                    index++;
                    if(index==5){
                        index=0;
                    }
                },2000);
            }
        }

        //根据名字显示或隐藏设备图层
        function hideOrShowLayer(params,isshow){//params格式['device1','device2',...] isshow:true/fasle
            var fnums = building.floorNums;//获取三维场景所有楼层[1,2,3]
            for(var i=0;i<fnums.length;i++){
                var floor = building.getFloor(fnums[i]);
                var res = floor.getLayersByNames(params);
                if(res&&res.length>0)
                    res[0].visible = isshow;
            }
        };
        var popMarker=null;
        function showPop(data) {//点击marker 弹出基本信息
            if(popMarker) popMarker.close();
            var types={"1":"摄像头","2":"消防设备","3":"保安"};
            var className = "close-"+data.ID; //生成唯一的class，用于关闭
            if(data.deviceType!=1){//如果点击的不是摄像头
                popMarker = new esmap.ESPopMarker({
                mapCoord: {
                    //设置弹框的x轴
                    x: data.x,
                    //设置弹框的y轴
                    y:data.y,
                    height: 3.5, //控制信息窗的高度
                    //设置弹框位于的楼层
                    fnum: data.FloorNum
                },
                className:"rock-box m-pop",  //自定义popMarker样式。在css里配置
                //设置弹框的宽度
                width: 300,
                //设置弹框的高度
                height: 150,
                //    marginTop:10,  //弹框距离地面的高度
                //设置弹框的内容
                content:'<div class="title"><span style="margin: 20px;">信息弹框</span></div>'+
                    '<div class="m-box">'+
                        '<div class="m-text">'+
                       '<p>' +
                           '<span class="m-span">id</span>' +
                            '<span class="m-span">名称</span>' +
                            '<span class="m-span">类型</span>' +
                        '</p>' +
                        '<p>' +
                            '<span class="m-span2">'+data.ID+'</span>'+
                            '<span class="m-span2 status">'+data.name+ '</span>'+
                            '<span class="m-span2 ">'+types[data.deviceType]+'</span>'+
                        '</p>'+
                        '</div>'+
                    '</div>'+
                    '<div class="myPopClose '+className+'"></div>',
                closeCallBack: function () {
                    //信息窗点击关闭操作
                },
                created: function (e) {
                    //创建完成钩子
                    $("."+className).on('click',function(){
                        //为自定义关闭按钮绑定隐藏事件
                        popMarker.close();
                    })
                }
            });
        }else{//点击摄像头
            popMarker = new esmap.ESPopMarker({
                    mapCoord: {
                        //设置弹框的x轴
                        x: data.x,
                        //设置弹框的y轴
                        y:data.y,
                        height: 3.5, //控制信息窗的高度
                        //设置弹框位于的楼层
                        fnum: data.FloorNum
                    },
                    className:"rock-box m-pop",  //自定义popMarker样式。在css里配置
                    //设置弹框的宽度
                    width: 300,
                    //设置弹框的高度
                    height: 220,
                    //    marginTop:10,  //弹框距离地面的高度
                    //设置弹框的内容
                    content:'<div class="title"><span>'+data.name+'</span></div>'+
                        '<div class="m-box">'+
                        '<video style="width: 100%;height: 100%;" controls autoplay>'+
                            '<source src="1.mp4"  type="video/mp4">'+
                        '</video>'+
                        '</div>'+
                        '<div class="myPopClose '+className+'"></div>',
                    closeCallBack: function () {
                        //信息窗点击关闭操作
                    },
                    created: function (e) {
                        //创建完成钩子
                        $("."+className).on('click',function(){
                            //为自定义关闭按钮绑定隐藏事件
                            popMarker.close();
                        })
                    }
                });
            }
        }
    </script>
</body>
</html>
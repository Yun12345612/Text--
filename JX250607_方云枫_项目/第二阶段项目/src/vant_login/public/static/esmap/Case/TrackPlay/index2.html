<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>易景三维三维场景轨迹回放方法2|室内三维可视化引擎|ESmap</title>
    <meta name="keywords" content="三维场景轨迹回放,人员轨迹回放,室内三维场景,三维场景引擎,室内定位,易景三维场景" />
    <meta name="description"
        content="易景三维场景轨迹回放方法2,人员轨迹回放方法2,易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet">
    <link href="css/common.css" rel="stylesheet">
    <link href="css/iconfont/iconfont.css" rel="stylesheet">
</head>
<style type="text/css">
    #pannel {
        position: absolute;
        left: 2%;
        bottom: 10%;
        z-index: 999;
    }

    #begin {
        background-color: rgb(97, 195, 212);
    }
</style>

<body ms-controller="ctrl" class="ms-controller">

    <div id="map-container"></div>


    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <h1><a href="/" title="室内三维场景-三维场景轨迹回放" target="_blank">易景室内三维可视化引擎</a>（三维场景轨迹回放方法2）</h1>

            <div class="tips-right">
                <span class="tip1"></span>
                <span class="tip2"></span>
            </div>
            <div class="tips-msg">
                <div class="msg msg1">
                    <div class="erweima"></div>
                    <p>手机扫一扫进入体验</p>
                </div>
                <div class="msg msg2">
                    <h4>轨迹回放功能</h4>
                    <p>1. 点击开始,图片文字标注显示轨迹,并实时更新轨迹回放</p>
                    <div style="display: none"></div>
                </div>
            </div>
        </div>
    </nav>
    <div id="pannel">
        <input type="button" id="begin" class="btn btn-default btnclass" value="BEGIN" />
    </div>
    <script src="../../lib/config.js"></script>
    <script src="../../lib/esmap-3.0.min.js"></script>
    <script src="../../lib/jquery-2.1.4.min.js"></script>
    <script src="../../lib/jquery.qrcode.min.js"></script>
    <script src="../../lib/tips_controls.js"></script>
    <script src="../../lib/bootstrap.min.js"></script>


    <script type="text/javascript">
        //定义全局map变量
        var map;
        var esmapID = getQueryString('id') || defaultOpt.mapID;
        var floorControl;
        var floorLayer;
        var coordIndex = 0; //坐标点下标
        var coordsData = null;
        var timer = -1;
        var mapCoord;
        var tm;
        var coord;
        var building;
        // 楼层控制控件配置参数（几楼）
        var ctlOpt = new esmap.ESControlOptions({
            position: esmap.ESControlPositon.RIGHT_TOP,
            imgURL: 'image/wedgets/'
            // allLayer: true
            // size:"normal"
        })
        // 放大、缩小控件配置
        var ctlOpt1 = new esmap.ESControlOptions({
            position: esmap.ESControlPositon.LEFT_TOP, // 位置 左上角
            // 位置x,y的偏移量
            offset: {
                x: 20,
                y: 60
            },
            imgURL: 'image/wedgets/'
        })
        map = new esmap.ESMap({
            mode: esmap.MapMode.Building,
            container: $('#map-container')[0], // 渲染dom
            mapDataSrc: "../../data", //三维场景数据位置
            focusAlphaMode: true, // 对不可见图层启用透明设置 默认为true
            focusAnimateMode: true, // 开启聚焦层切换的动画显示
            focusAlpha: 0.9, // 对不聚焦图层启用透明设置，当focusAlphaMode = true时有效
            mapAudioSrc: '../lib',
            token: 'escope',
            focusFloor: 1
        });
        map.openMapById(esmapID);
        map.showCompass = true; //显示指南针 

        $.getJSON("data3.json", function (data) {
            coordsData = data.points; //获取json数据的数组对象
        });

        //三维场景加载完成回调
        map.on('loadComplete', function () {
            building = map.getBuilding();
            floorControl = new esmap.ESScrollFloorsControl(map, ctlOpt);
            var zoomControl = new esmap.ESZoomControl(map, ctlOpt1);
            bingEvents();
        });

        var begin = document.getElementById("begin");
        begin.onclick = function () {
            if (timer != -1) {
                return;
            }
            flag = true;
            coordIndex = 0;
            updateCoord();
        }

        function CreateMarker(x, y, fnum) { //标注坐标点， 所在楼层
            var layer = new esmap.ESLayer('textMarker'); //创建标注图层
            floorLayer = building.getFloor(fnum); // 所在楼层
            // console.log(floorLayer);
            tm = new esmap.ESTextMarker({
                x: x,
                y: y,
                text: "小张",
                showLevel: 20,
                height: 0.5,
                image: "image/user.png",
                imageStyle:{
                    align: 'bottom',
                },
                textStyle:{
                    fillStyle: "1,6,7", //填充色
                    fontSize: "8.0", //字体大小
                    strokeStyle: "255,255,0" //边框色  
                },
                seeThrough: true,
            });
            layer.addMarker(tm); //将标注添加到图层
            floorLayer.addLayer(layer); //将图层添加到楼层
        }
        let j = 0;
        function updateCoord() { //实时刷新轨迹线
            var lastpoint = {};
            var linecnt = 0;
            var points = [];
            var lastfnum = 0;
            timer = setInterval(updated, 100);

            function updated() {
                if (coordIndex >= coordsData.length) {
                    clearInterval(timer);
                    timer = -1;
                    map.clearAllLineMark();
                    building.getFloor(lastfnum).removeLayersByTypes(esmap.ESLayerType.TEXT_MARKER);
                    return;
                }
                var coord = coordsData[coordIndex]; //取坐标点
                if (building.focusFloorNum != coord.fnum)
                    building.focusFloorNum = coord.fnum; //判断聚焦楼层 

                if (lastfnum != coord.fnum) { //如果切换楼层了
                    if (lastfnum > 0)
                        building.getFloor(lastfnum).removeLayersByTypes(esmap.ESLayerType.TEXT_MARKER); //先移除上一个楼层的标注
                    CreateMarker(coord.x, coord.y, coord.fnum); //再在新楼层添加一个标注
                    lastfnum = coord.fnum;
                }
                tm.moveTo({
                    x: coord.x,
                    y: coord.y,
                    time: 0
                });

                //从第二个点开始绘制线段，每两个点就绘制一个线段
                if (lastpoint) {
                    //判断是否与前一个点一样的坐标
                    if (Math.abs(lastpoint.x - coord.x) < 0.0001 && Math.abs(lastpoint.y - coord.y) < 0.0001)
                        return;
                    else {
                        drawLine([lastpoint, coord], ++linecnt);
                    }
                }
                lastpoint = coord;

                coordIndex++;
            }
        }
        //配置线标注样式
        var lineStyle = {
            lineWidth: 3,
            alpha: 0.8,
            offsetHeight: 0,
            lineType: esmap.ESLineType.FULL //实线
        }
        //画轨迹线函数
        function drawLine(points, index) {
            if (points.length && points.length <= 1) return; //两个点以上画线

            //缓存里面只留100，可以改
            if (index > 100)
                map.clearLineMarkById("iex" + (index - 100));
            //创建线标注对象
            line = new esmap.ESLineMarker({
                id: "iex" + index,
                points,
                lineStyle
            });
            //调用三维场景的画线方法
            map.drawLineMark(line);
        }

    </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>室内三维场景轨迹回放-人员轨迹回放|易景三维可视化平台</title>
    <meta name="keywords" content="室内三维场景轨迹回放,人员轨迹回放,室内三维场景,三维场景引擎,室内定位,易景三维场景" />
    <meta name="description" content="室内三维场景轨迹回放,人员轨迹回放,易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。" />
    <link href="../../lib/bootstrap.min.css" rel="stylesheet">
    <link href="css/common.css" rel="stylesheet">
    <link href="css/iconfont/iconfont.css" rel="stylesheet">
</head>
<style type="text/css">
    #pannel {
        position: absolute;
        left: 2%;
        bottom: 10%;
        z-index: 999;
    }

    #begin {
        background-color: rgb(97, 195, 212);
    }
</style>

<body ms-controller="ctrl" class="ms-controller">
    <div id="map-container"></div>
    
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <h1><a href="/" title="室内三维场景-三维场景轨迹回放" target="_blank">易景室内三维可视化引擎</a>（室内三维场景轨迹回放）</h1>

            <div class="tips-right">
                <span class="tip1"></span>
                <a class="tip2" onclick="tipClick('/api/senior/pathNavigation/')"></a>
            </div>
            <div class="tips-msg">
                <div class="msg msg1">
                    <div class="erweima"></div>
                    <p>手机扫一扫进入体验</p>
                </div>
                <div class="msg msg2">
                    <h4>室内三维场景轨迹回放功能(人员轨迹回放)</h4>
                    <p>1. 点击开始,图片文字标注显示轨迹,并实时更新轨迹回放</p>
                    <p>2. 模拟真实从后台接口拉取需要回放的人员轨迹点数据</p>
                    <div style="display: none">室内三维场景轨迹回放,人员轨迹回放,易景室内三维可视化引擎提供三维场景浏览、缩放、旋转、图层显隐等基础功

能，支持自定义室内三维场景显示风格及样式，可自动绘制楼层热力图、散点图等专题三维场景，快速进行空间大数据分析展示。支持跨楼层精准的点到点之间的最短

、最优路径计算，支持对路径结果进行导航和动画,并提供丰富的三维场景主题资源供二次开发调用。</div>
                </div>
            </div>
        </div>
    </nav>
    <div id="pannel">
        <input type="button" id="begin" class="btn btn-default btnclass" value="开始" />
    </div>
    <script src="../../lib/config.js"></script>
    <script src="../../lib/esmap-3.0.min.js"></script>
    <script src="../../lib/jquery-2.1.4.min.js"></script>
    <script src="../../lib/jquery.qrcode.min.js"></script>
    <script src="../../lib/tips_controls.js"></script>
    <script src="../../lib/bootstrap.min.js"></script>

    <script type="text/javascript">
        //定义全局map变量
        var map;
        var esmapID = getQueryString('id') || defaultOpt.mapID;
        var floorControl;
        var floorLayer;
        var coordIndex = 0; //坐标点下标
        var coordsData = null;
        var timer = -1;
        var mapCoord;
        var tm, tm2, tm3, layer1, layer2, layer3;
        var coord;
        var line = null;
        var building;
        // 楼层控制控件配置参数（几楼）
        var ctlOpt = new esmap.ESControlOptions({
            position: esmap.ESControlPositon.RIGHT_TOP,
            imgURL: 'image/wedgets/'
            // allLayer: true
            // size:"normal"
        })
        // 放大、缩小控件配置
        var ctlOpt1 = new esmap.ESControlOptions({
            position: esmap.ESControlPositon.LEFT_TOP, // 位置 左上角
            // 位置x,y的偏移量
            offset: {
                x: 20,
                y: 60
            },
            imgURL: 'image/wedgets/'
        })
        map = new esmap.ESMap({
            mode: esmap.MapMode.Building,
            container: $('#map-container')[0], // 渲染dom
            mapDataSrc: "../../data", //三维场景数据位置
            focusAlphaMode: true, // 对不可见图层启用透明设置 默认为true
            focusAnimateMode: true, // 开启聚焦层切换的动画显示
            focusAlpha: 0.9, // 对不聚焦图层启用透明设置，当focusAlphaMode = true时有效
            mapAudioSrc: '../lib',
		    token:'escope',
            focusFloor: 1
        });
        map.openMapById(esmapID);
        map.showCompass = true; //显示指南针 

        //从后台接口拉取需要回放的人员轨迹点数据
        $.getJSON("data.json", function (data) {
            coordsData = data.points;
        });

         //三维场景加载完成回调
         map.on('loadComplete', function () {
            building = map.getBuilding();
            floorControl = new esmap.ESScrollFloorsControl(map, ctlOpt);
            // var zoomControl = new esmap.ESZoomControl(map, ctlOpt1);
        });

        var begin = document.getElementById("begin");
        begin.onclick = function () {
            if (timer != -1) {
                return;
            }
            flag = true;
            coordIndex = 0;
            updateCoord();
        }

        function CreateMarker(x, y, fnum) { //标注起始坐标点， 所在楼层
            layer = new esmap.ESLayer('textMarker');
            floorLayer = building.getFloor(fnum); // 所在楼层
            tm = new esmap.ESTextMarker({
                x: x, //gpos1.x - 16
                y: y, //gpos1.y + 25
                text: "小张",
                showLevel: 20,
                height: 0.5,
                image: "image/user.png",
                imageStyle:{
                    align: 'bottom',
                },
                seeThrough: true,
                textStyle:{
                    fillStyle: "#FFFFFF", //填充色
                    fontSize: 16, //字体大小
                    strokeStyle: "#000" //边框色  
                }
            });
            layer.addMarker(tm);
            floorLayer.addLayer(layer);
        }

        function updateCoord() { //实时刷新轨迹线
            var points = [];
            var lastfnum=0;
            timer = setInterval(updated, 100);
            function updated() {
                if (coordIndex >= coordsData.length) {//数据用完了，关掉定时器，清0
                    clearInterval(timer);
                    timer = -1;
                    map.clearLineMarkById("routes");
                    line = null;
                    if(lastfnum>0)
                    building.getFloor(lastfnum).removeLayersByTypes(esmap.ESLayerType.TEXT_MARKER);
                    return;
                }

                var coord = coordsData[coordIndex]; //取坐标点
                coord.bid= building.id;
                if(building.focusFloorNum != coord.fnum){
                    building.focusFloorNum = coord.fnum; //判断聚焦楼层 
                    building.visibleFloorNums = [coord.fnum]; //判断聚焦楼层 
                }
   
                if(lastfnum!=coord.fnum)//切换层的时候先要清除之前层的Marker
                {
                    if(lastfnum>0)
                    building.getFloor(lastfnum).removeLayersByTypes(esmap.ESLayerType.TEXT_MARKER);
                    CreateMarker(coord.x, coord.y, coord.fnum);
                    lastfnum=coord.fnum;
                    points = [];
                }
                //过滤前后重复的
                if (points.length && points.length > 0)
                {
                    var chge = ckSamePt(points[points.length - 1], coord);
            		if (chge)
            			return;
                }
				
                tm.moveTo({
                    x: coord.x,
                    y: coord.y,
                    time: 0
                });
                //只保留16个点  画轨迹线
                if (points.length > 16) {
                    points.shift(); //先踢掉第一个
                }
                
                points.push(coord); //在把新点加入进去
                
                drawLine(points);
                coordIndex++;
            }
        }

        //配置线标注样式
        var lineStyle = {
            lineWidth: 3,
            alpha: 0.8,
            offsetHeight: 0,
            hiddenByFloor:false,
            url: 'image/arrow.png',  //贴图线图片url
            lineType: esmap.ESLineType.TEXTURE,
        }

        //画轨迹线
        function drawLine(points) {
            if (points.length && points.length <= 1) return;
            changeSameP(points);
            if(line){
                line.updatePoints(points);
            }else{
                console.log('drawline')
                //创建线标注对象
                line = new esmap.ESLineMarker({
                    id: 'routes',
                    points,
                    style: lineStyle,
                });
                 //调用三维场景的画线方法
                map.drawLineMark(line);
            }
        }
        
        //来回画线坐标重复导致线不显示的问题,采用重复坐标点偏移一些来解决
        function changeSameP(points) {
            if (points.length && points.length < 3) return;
            let chge = ckSamePt(points[points.length - 1], points[points.length - 3]);
            if (chge) {
                points[points.length - 1].x += 0.001;
                points[points.length - 1].y += 0.001;
                return points;
            } else {
                return points;
            }
        }

        //判断两点是否相等
        function ckSamePt(p1, p2) {
            if (p1.fnum != p2.fnum) {
                return false;
            }
            if (Math.abs(p1.x - p2.x) < 0.0001 && Math.abs(p1.y - p2.y) < 0.0001) { //判断两点间距离
                return true;
            }
            return false;
        }
    </script>
</body>

</html>
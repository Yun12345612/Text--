<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.springboot_hd.mapper.RoleMapper">

    <!-- 通用结果集映射 -->
    <resultMap id="BaseResultMap" type="org.example.springboot_hd.entity.Role">
        <id column="role_id" property="roleId"/>
        <result column="role_name" property="roleName"/>
        <result column="role_status" property="roleStatus"/>
        <result column="role_desc" property="roleDesc"/>
        <result column="role_is_delete" property="roleIsDelete"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 1.根据ID查询单个角色 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
            role_id,
            role_name,
            role_status,
            role_desc,
            role_is_delete,
            update_time,
            create_time
        FROM
            role
        WHERE
            role_id = #{roleId}
          AND role_is_delete = '0'  -- 只查询未删除的数据
    </select>

    <!-- 2.带条件查询角色列表（仅接收分页参数，不做运算） -->
    <!-- 角色列表查询：直接使用pageNum（偏移量）和pageSize -->
    <select id="selectList" parameterType="org.example.springboot_hd.entity.Role" resultMap="BaseResultMap">
        SELECT role_id, role_name, role_status, role_desc, role_is_delete, create_time, update_time
        FROM role
        WHERE role_is_delete = '0'
        <if test="roleName != null and roleName != ''">
            AND role_name LIKE CONCAT('%', #{roleName}, '%')
        </if>
        <if test="roleStatus != null">
            AND role_status = #{roleStatus}
        </if>
        <!-- 与科室保持一致：LIMIT 偏移量, 每页条数 -->
        <if test="pageNum != null and pageSize != null">
            LIMIT #{pageNum}, #{pageSize}
        </if>
    </select>
    <!-- 3.查询总条数（配合分页使用） -->
    <select id="selectCount" parameterType="org.example.springboot_hd.entity.Role" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM role
        WHERE
        role_is_delete = '0'  -- 只统计未删除的数据
        <if test="roleName != null and roleName != ''">
            AND role_name LIKE CONCAT('%', #{roleName}, '%')
        </if>
        <if test="roleStatus != null">
            AND role_status = #{roleStatus}
        </if>
    </select>

    <!-- 4.添加角色 -->
    <insert id="insert" parameterType="org.example.springboot_hd.entity.Role">
        INSERT INTO role (
            role_name,
            role_status,
            role_desc,
            role_is_delete,
            create_time,
            update_time
        ) VALUES (
                     #{roleName},
                     #{roleStatus},
                     #{roleDesc},
                     '0',  -- 新增默认未删除
                     NOW(),  -- 默认为当前时间
                     NOW()   -- 默认为当前时间
                 )
    </insert>

    <!-- 5.修改角色 -->
    <update id="update" parameterType="org.example.springboot_hd.entity.Role">
        UPDATE role
        SET
        <if test="roleName != null and roleName != ''">
            role_name = #{roleName},
        </if>
        <if test="roleStatus != null">
            role_status = #{roleStatus},
        </if>
        <if test="roleDesc != null and roleDesc != ''">
            role_desc = #{roleDesc},
        </if>
        update_time = NOW()  -- 更新时间为当前时间
        WHERE
        role_id = #{roleId}
        AND role_is_delete = '0'  -- 只更新未删除的数据
    </update>

    <!-- 6.软删除角色（更新删除标记） -->
    <update id="softDeleteById" parameterType="java.lang.Long">
        UPDATE role
        SET
            role_is_delete = '1',  -- 标记为已删除
            update_time = NOW()    -- 更新删除时间
        WHERE
            role_id = #{roleId}
          AND role_is_delete = '0'  -- 只删除未删除的数据
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.springboot_hd.mapper.RoleMenuMapper">

    <!--1.根据角色id查询关联菜单-->
    <!-- 修改后的SQL - 获取角色关联菜单及其所有父级菜单 -->
    <select id="selectMenusByRoleId" resultType="org.example.springboot_hd.entity.Menu">
        WITH RECURSIVE menu_tree AS (
            -- 基础情况：获取角色直接关联的菜单
            SELECT
                m.id,
                m.menu_name,
                m.menu_path,
                m.parent_id,
                m.icon
            FROM role_menu rm
                     INNER JOIN menu m ON rm.menu_id = m.id
            WHERE rm.role_id = #{roleId}

            UNION

            -- 递归情况：获取所有父级菜单
            SELECT
                p.id,
                p.menu_name,
                p.menu_path,
                p.parent_id,
                p.icon
            FROM menu p
                     INNER JOIN menu_tree mt ON p.id = mt.parent_id
            WHERE p.parent_id IS NOT NULL OR p.id != 0
            )
        SELECT DISTINCT
            id,
            menu_name,
            menu_path,
            parent_id,
            icon
        FROM menu_tree
        ORDER BY id
    </select>
</mapper>
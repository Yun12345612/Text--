<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.springboot_hd.mapper.AdminMapper">

    <!-- 1. 管理员登录：根据账号查询 -->
    <select id="getAdminByAccount" resultType="org.example.springboot_hd.entity.Admin">
        SELECT
            id,
            name,
            account,
            password,
            salt,
            is_delete AS isDelete,
            role_id AS roleId
        FROM admin
        WHERE account = #{account}
          AND is_delete = 0
    </select>

    <!-- 2. 管理员注册：插入新用户 -->
    <insert id="insertAdmin">
        INSERT INTO admin (
            name,
            account,
            password,
            salt,
            role_id,
            status,
            is_delete,
            department_id,
            create_time,
            update_time
        ) VALUES (
                     #{name},
                     #{account},
                     #{password},
                     #{salt},
                     #{roleId},
                     #{status},
                     #{isDelete},
                     #{departmentId},
                     NOW(),
                     NOW()
                 )
    </insert>

    <!-- 新增管理员 -->
    <insert id="addAdmin">
        insert into admin(name, account, password, salt, status,
                          department_id, is_delete, create_time, update_time)
        VALUES (#{name}, #{account}, #{password}, #{salt}, #{status},
                #{departmentId}, #{isDelete}, NOW(), NOW())
    </insert>

    <!-- 3. 管理员修改：更新用户 -->
    <update id="updateAdmin">
        UPDATE admin
        <set>
            <if test="account != null and account != ''">
                account = #{account},
            </if>
            <if test="password != null and password != ''">
                password = #{password},
            </if>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="isDelete != null">
                is_delete = #{isDelete},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="roleId != null">
                role_id = #{roleId},
            </if>
            <if test="status != null">
                status = #{status}
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 软删除管理员 -->
    <update id="softDeleteAdmin">
        UPDATE admin
        SET is_delete = 1
        WHERE id = #{id}
    </update>

    <!-- 4. 管理员查询 -->
    <select id="selectAdminList" resultType="org.example.springboot_hd.entity.Admin">
        SELECT
        a.id,
        a.name,
        r.role_name AS roleName,
        a.status,
        a.is_delete AS isDelete,
        a.role_id AS roleId
        FROM admin a
        LEFT JOIN role r ON a.role_id = r.role_id
        WHERE a.is_delete = 0
        <if test="name != null and name != ''">
            AND a.name LIKE CONCAT('%', #{name}, '%')
        </if>
        LIMIT #{start}, #{pageSize}
    </select>

    <!-- 5. 管理员查询：总条数统计 -->
    <select id="selectAdminCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM admin
        <where>
            <if test="account != null and account != ''">
                AND account LIKE CONCAT('%', #{account}, '%')
            </if>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="isDelete != null">
                AND is_delete = #{isDelete}
            </if>
            <if test="isDelete == null">
                AND is_delete = 0
            </if>
        </where>
    </select>

</mapper>
